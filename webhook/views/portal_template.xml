<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id = "portal_layout_inherit"
              inherit_id = "portal.portal_layout">
        <xpath expr="//div[@class='o_portal_my_security mt-3']" position="after">
            <div class = "o_portal_my_webhooks mt-3">
                <h4>Webhooks</h4>
                <hr class="mt-1 mb-1"/>
                <a href="/my/webhook/"><i class="fa fa-pencil mx-1"/>Manage Webhooks</a>
            </div>
        </xpath>
    </template>

    <template id = "portal_my_webhook">
        <t t-call = "portal.portal_layout">
            <div class="o_portal_security_body">
                <t t-set="additional_title">Webhook</t>
                <t t-set="no_breadcrumbs" t-value="1"/>
                <h2>Webhook
                    <a href="https://en.wikipedia.org/wiki/Webhook" target ="_blank">
                        <i title="Documentation" class="fa fa-fw o_button_icon fa-info-circle"/>
                    </a>
                </h2>
                <hr class="mt-1 mb-1"/>
                <section>
                    <h3>Subscribe to a new webhook</h3>
                    <form action = "" method ="post">
                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                        <input type = "hidden" name="uid" t-att-value="request.uid"/>
                        <input type = "hidden" name="previous_selected_webhooks" t-att-value = "selected_webhooks"/>
                        <div class = "form-group">
                            <label for="webhook_url">Webhook URL:</label>
                            <input id ="webhook_url" name = "webhook_url" t-attf-class="form-control form-control-sm" placeholder = "Enter your URL" />
                        </div>
                        <label>Choose webhooks to subscribe:</label>
                        <table class = "table o_main_table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th/>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach = "selected_webhooks" t-as = "selected_webhook">
                                    <tr>
                                        <td><t t-esc = "request.env['base.automation'].sudo().search([('id','=',int(selected_webhook))]).name"></t></td>
                                        <td>
                                        <button name = "deleteRow" class="fa fa-trash text-danger" type="submit" />
                                        </td>
                                    </tr>
                                </t>
                                <tr>
                                    <td>
                                        <select class ="form-control" name = "webhook_id" >
                                            <t t-foreach = "webhooks" t-as="webhook">
                                                <option t-att-value="webhook.id" t-esc="webhook.name" t-field = "webhook.name"/>
                                            </t>
                                        </select>
                                    </td>
                                    <td>
                                        <button name = "addRow" class="fa fa-plus-circle text-primary" type="submit"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <button name = "submit" type="submit" class="btn btn-primary">Submit</button>
                   </form>
<!--                    <p><t t-out="base_automations"/> </p>-->
                </section>
                <section>
                    <h3>Webhook Subscriptions</h3>
                     <div>
                    <table class="table o_main_table">
                        <thead>
                            <tr>
                                <th>URL</th>
                                <th>Subscribed Actions</th>
<!--                                <th>Added On</th>-->
                                <th/>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="request.env.user.webhook_subscriptions" t-as="webhook_subscription">
                                <tr>
                                    <td><span t-field="webhook_subscription.webhook_url"/></td>
                                    <td><span t-field="webhook_subscription.automated_actions"/></td>
<!--                                    <td><span t-field="key.create_date"/></td>-->
                                    <td>
<!--                                        <i class="fa fa-trash text-danger o_portal_remove_api_key" type="button" t-att-id="key.id"/>-->
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
                </section>
            </div>
        </t>
    </template>
</odoo>